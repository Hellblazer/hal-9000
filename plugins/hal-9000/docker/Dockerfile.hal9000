# HAL-9000 Base Image with Claude CLI
# Pre-installs Claude CLI + claude-code-tools + MCP servers for instant container startup
#
# Build: docker build -f docker/Dockerfile.hal9000 -t ghcr.io/hellblazer/hal-9000:latest .
# Publish: docker push ghcr.io/hellblazer/hal-9000:latest
# Use with aod: aod.sh automatically uses this image

# debian:bookworm-slim (pinned 2026-01-31)
FROM debian@sha256:56ff6d36d4eb3db13a741b342ec466f121480b5edded42e4b7ee850ce7a418ee

LABEL maintainer="hal-9000"
LABEL description="HAL-9000 base image with Claude CLI, MCP servers, and claude-code-tools"
LABEL version="1.4.0"
LABEL mcp_servers="memory-bank-mcp:0.2.2, sequential-thinking:2025.12.18, chroma-mcp:0.2.6"
LABEL build_date="2026-01-25"
LABEL claude_method="native_build"

# Install system dependencies including Python 3 (for chroma-mcp)
# Also install locale and terminal packages for proper UTF-8 and TUI support
RUN apt-get update && apt-get install -y \
    curl \
    git \
    tmux \
    build-essential \
    ca-certificates \
    python3 \
    python3-pip \
    python3-venv \
    docker.io \
    locales \
    ncurses-term \
    && rm -rf /var/lib/apt/lists/* \
    && sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen \
    && locale-gen

# Set locale and terminal environment for proper Unicode/TUI support
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV TERM=xterm-256color

# Install Claude Code native binary (recommended method as of January 2026)
# See: https://code.claude.com/docs/en/setup
# Native build provides auto-updates and security fixes
RUN curl -fsSL https://claude.ai/install.sh | bash

# Install Node.js 20 LTS for MCP servers and development
# (Not needed for Claude Code binary itself, only for MCP npm packages)
# Note: NodeSource package includes npm, don't install npm separately
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Pre-install MCP server npm packages globally (pinned to latest stable versions)
# Updated 2026-01-25: memory-bank-mcp@0.2.2, sequential-thinking@2025.12.18
RUN npm install -g \
    @allpepper/memory-bank-mcp@0.2.2 \
    @modelcontextprotocol/server-sequential-thinking@2025.12.18

# Install uv (fast Python package installer)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# Add uv and claude-code-tools to PATH
ENV PATH="/root/.local/bin:${PATH}"

# Pre-install claude-code-tools (tmux-cli, vault, env-safe, aichat)
RUN uv tool install claude-code-tools

# Pre-install chroma-mcp (ChromaDB MCP server)
# Pinned to latest stable version (0.2.6 as of Jan 2026)
# Use uv tool install for CLI tools (avoids externally managed Python issues)
RUN uv tool install chroma-mcp==0.2.6

# Create workspace and hal-9000 mount point
RUN mkdir -p /workspace /hal-9000 /root/memory-bank

# Set environment variables for MCP servers and Claude Code
ENV CLAUDE_HOME="/root/.claude"
ENV MEMORY_BANK_ROOT="/root/memory-bank"

WORKDIR /workspace

# Verify installations
RUN echo "Verifying installations..." \
    && claude --version \
    && node --version \
    && npm --version \
    && docker --version \
    && mcp-server-memory-bank --version > /dev/null 2>&1 || echo "⚠ mcp-server-memory-bank available" \
    && mcp-server-sequential-thinking --version > /dev/null 2>&1 || echo "⚠ mcp-server-sequential-thinking available" \
    && chroma-mcp --help > /dev/null 2>&1 \
    && tmux-cli --help > /dev/null 2>&1 \
    && echo "✓ Claude Code, Docker CLI, MCP servers, and tools installed successfully"

# Default command runs setup script then starts bash
CMD ["bash", "-c", "source /hal-9000/setup.sh 2>/dev/null || true; exec bash"]
