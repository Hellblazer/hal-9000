# HAL-9000 Parent Container (DinD Orchestrator)
# Container for spawning and managing Claude worker containers
#
# Architecture:
# - Parent runs ChromaDB server on port 8000 for shared vector storage
# - Parent owns network namespace, spawns workers
# - Workers use --network=container:parent to access localhost:8000
# - Workers connect to ChromaDB via HTTP (safe for concurrent access)
#
# Build: docker build -f Dockerfile.parent -t ghcr.io/hellblazer/hal-9000:parent .
# Run with resource limits (Issue #10 - Resource limits):
#   docker run -d --name hal9000-parent \
#     --memory=2g --memory-swap=2g \
#     --cpus=2 \
#     -v /var/run/docker.sock:/var/run/docker.sock \
#     -v ~/.hal9000:/root/.hal9000 \
#     -v hal9000-chromadb:/data/chromadb \
#     ghcr.io/hellblazer/hal-9000:parent
#
# Resource limits configuration (optional, defaults recommended):
#   --memory=2g          # Memory limit: 2GB (accommodate ChromaDB + orchestration)
#   --memory-swap=2g     # Swap limit: same as memory (disable swap)
#   --cpus=2             # CPU limit: 2 cores (for orchestration + ChromaDB)
#
# Note: Workers inherit resource limits from Docker daemon configuration.
# For production use, ensure host has sufficient resources:
#   - Parent: 2GB RAM, 2 CPU cores
#   - Workers: 512MB-1GB RAM each, shared CPU
#   - Total: 8GB+ RAM for 10 concurrent workers + parent

FROM debian:bookworm-slim

LABEL maintainer="hal-9000"
LABEL description="HAL-9000 parent container - DinD orchestrator for Claude workers"
LABEL version="1.0.0"
LABEL architecture="dind-parent"
LABEL build_date="2026-01-25"

# Install dependencies for orchestration and ChromaDB server
# - tmux: Session management for workers
# - curl: Health checks and API calls
# - jq: JSON processing for configuration
# - procps: Process monitoring (ps, top)
# - python3: Required for ChromaDB server
RUN apt-get update && apt-get install -y --no-install-recommends \
    tmux \
    curl \
    jq \
    procps \
    ca-certificates \
    locales \
    gnupg \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/* \
    && sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen \
    && locale-gen

# Create hal9000 group for socket directory group ownership
# GID 1001 matches worker's claude user GID for consistency
RUN groupadd -g 1001 hal9000

# Install ChromaDB server in a virtual environment
RUN python3 -m venv /opt/chromadb-venv \
    && /opt/chromadb-venv/bin/pip install --no-cache-dir chromadb

# Add ChromaDB to PATH
ENV PATH="/opt/chromadb-venv/bin:${PATH}"

# Install Docker CLI (latest version for API compatibility)
# Using official Docker repository for up-to-date client
RUN curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian bookworm stable" > /etc/apt/sources.list.d/docker.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends docker-ce-cli \
    && rm -rf /var/lib/apt/lists/*

# Set locale for proper Unicode support
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV TERM=xterm-256color

# Create directory structure
# /root/.hal9000 - Persistent state directory (mounted volume)
#   /sessions    - Worker session metadata
#   /logs        - Container logs
#   /config      - Configuration files
# /data/chromadb - ChromaDB persistent storage (mounted volume)
RUN mkdir -p \
    /root/.hal9000/sessions \
    /root/.hal9000/logs \
    /root/.hal9000/config \
    /data/chromadb \
    /workspace \
    /scripts

# Copy orchestration scripts
COPY docker/parent-entrypoint.sh /scripts/parent-entrypoint.sh
COPY docker/spawn-worker.sh /scripts/spawn-worker.sh
COPY docker/coordinator.sh /scripts/coordinator.sh
COPY docker/init-volumes.sh /scripts/init-volumes.sh
COPY docker/setup-dashboard.sh /scripts/setup-dashboard.sh
COPY docker/tmux-dashboard.conf /scripts/tmux-dashboard.conf

# Copy shared libraries (audit logging, etc.)
COPY docker/lib/ /scripts/lib/

# Copy TMUX control utilities
COPY scripts/tmux-send.sh /scripts/tmux-send.sh
COPY scripts/tmux-attach.sh /scripts/tmux-attach.sh
COPY scripts/tmux-list-sessions.sh /scripts/tmux-list-sessions.sh

# Make scripts executable
RUN chmod +x /scripts/*.sh

# Environment variables
ENV HAL9000_HOME=/root/.hal9000
ENV HAL9000_SESSIONS_DIR=/root/.hal9000/sessions
ENV HAL9000_LOGS_DIR=/root/.hal9000/logs
ENV WORKER_IMAGE=ghcr.io/hellblazer/hal-9000:worker

# Resource limit configuration (Issue #10)
# These are defaults that can be overridden at runtime with docker run flags.
# Actual enforcement requires --memory and --cpus flags to docker run.
ENV HAL9000_MEMORY_LIMIT=2g
ENV HAL9000_CPU_LIMIT=2
ENV CHROMADB_MEMORY_LIMIT=1g
ENV WORKER_MEMORY_LIMIT=512m

# ChromaDB server configuration
ENV CHROMADB_HOST=0.0.0.0
ENV CHROMADB_PORT=8000
ENV CHROMADB_DATA_DIR=/data/chromadb
ENV CHROMA_ANONYMIZED_TELEMETRY=false

WORKDIR /workspace

# Health check - verify Docker socket accessible
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD docker ps >/dev/null 2>&1 || exit 1

# Default entrypoint
ENTRYPOINT ["/scripts/parent-entrypoint.sh"]

# Default command (can be overridden)
CMD ["coordinator"]
