# HAL-9000 Worker Container
# Claude Code environment with foundation MCP servers + marketplace support
#
# Foundation MCP servers (pre-installed):
# - ChromaDB: Client connects to parent's server (localhost:8000)
# - Memory Bank: Shared volume mount, global to all workers
# - Sequential Thinking: Stateless reasoning tool
#
# Additional MCP servers can be installed via marketplace.
#
# Build: docker build -f Dockerfile.worker -t ghcr.io/hellblazer/hal-9000:worker .

FROM debian:bookworm-slim

LABEL maintainer="hal-9000"
LABEL description="HAL-9000 worker - Claude CLI with foundation MCP servers"
LABEL version="3.0.0"
LABEL architecture="dind-worker"
LABEL mcp_servers="chromadb, memory-bank, sequential-thinking"
LABEL build_date="2026-01-26"

# Install system dependencies
# - curl: Claude CLI installation and health checks
# - git: Development workflows
# - tmux: Session management
# - python3 + venv: Python MCP servers
# - nodejs: npm MCP servers
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    git \
    tmux \
    python3 \
    python3-pip \
    python3-venv \
    locales \
    ncurses-term \
    gnupg \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /usr/share/doc/* /usr/share/man/* \
    && sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen \
    && locale-gen

# Set locale for proper UTF-8 support
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV TERM=xterm-256color

# Install Node.js 20 LTS (required for npm-based MCP servers)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install Claude CLI (native binary)
RUN curl -fsSL https://claude.ai/install.sh | bash

# Add Claude CLI to PATH
ENV PATH="/root/.local/bin:${PATH}"

# Install uv (fast Python package installer)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# ============================================================================
# Foundation MCP Servers
# ============================================================================

# Memory Bank - persistent memory across sessions (npm)
# Data stored in shared volume: /data/memory-bank
RUN npm install -g @allpepper/memory-bank-mcp@0.2.2

# Sequential Thinking - step-by-step reasoning (npm)
RUN npm install -g @modelcontextprotocol/server-sequential-thinking@2025.12.18

# ChromaDB MCP client - connects to parent's ChromaDB server (Python)
RUN uv tool install chroma-mcp==0.2.6

# ============================================================================
# Non-Root User (Security Hardening)
# ============================================================================

# Create non-root user for running Claude
# UID/GID 1000 matches common host user for volume permissions
ARG CLAUDE_UID=1000
ARG CLAUDE_GID=1000

RUN groupadd -g ${CLAUDE_GID} claude && \
    useradd -u ${CLAUDE_UID} -g claude -m -d /home/claude -s /bin/bash claude

# ============================================================================
# Directory Structure
# ============================================================================

# Create directories for:
# - /workspace: Project files (mounted per-session)
# - /home/claude/.claude: CLAUDE_HOME (shared volume for marketplace)
# - /data/memory-bank: Memory Bank data (shared volume)
RUN mkdir -p /workspace /home/claude/.claude /data/memory-bank /scripts && \
    chown -R claude:claude /workspace /home/claude /data/memory-bank /scripts

# Copy all tools to user's local bin (installed as root, now available to claude user)
# Includes: Claude CLI, uv, uvx, chroma-mcp, and any other uv-installed tools
# Preserve permissions with -p and ensure executability
RUN mkdir -p /home/claude/.local/bin && \
    cp -rp /root/.local/bin/* /home/claude/.local/bin/ 2>/dev/null || true && \
    chmod +x /home/claude/.local/bin/* 2>/dev/null || true && \
    chown -R claude:claude /home/claude/.local

# Copy entrypoint script
COPY docker/worker-entrypoint.sh /scripts/worker-entrypoint.sh
RUN chmod +x /scripts/worker-entrypoint.sh

# Environment variables
ENV CLAUDE_HOME=/home/claude/.claude
ENV WORKSPACE=/workspace
ENV MEMORY_BANK_ROOT=/data/memory-bank
ENV CHROMADB_HOST=localhost
ENV CHROMADB_PORT=8000
ENV HOME=/home/claude
ENV PATH="/home/claude/.local/bin:${PATH}"

# Switch to non-root user
USER claude

WORKDIR /workspace

# Verify installations
RUN echo "Verifying installations..." \
    && claude --version \
    && node --version \
    && npm --version \
    && uv --version \
    && mcp-server-memory-bank --version > /dev/null 2>&1 || echo "✓ memory-bank ready" \
    && mcp-server-sequential-thinking --version > /dev/null 2>&1 || echo "✓ sequential-thinking ready" \
    && chroma-mcp --help > /dev/null 2>&1 \
    && echo "✓ Foundation MCP servers installed"

# Health check
HEALTHCHECK --interval=60s --timeout=10s --start-period=5s --retries=3 \
    CMD claude --version >/dev/null 2>&1 || exit 1

ENTRYPOINT ["/scripts/worker-entrypoint.sh"]
CMD ["claude"]
