# HAL-9000 Worker Container
# Claude Code environment with foundation MCP servers + marketplace support
#
# Foundation MCP servers (pre-installed):
# - ChromaDB: Client connects to parent's server (localhost:8000)
# - Memory Bank: Shared volume mount, global to all workers
# - Sequential Thinking: Stateless reasoning tool
#
# Additional MCP servers can be installed via marketplace.
#
# Build: docker build -f Dockerfile.worker -t ghcr.io/hellblazer/hal-9000:worker .

# node:20-bookworm-slim (pinned 2026-01-31)
FROM node@sha256:6c51af7dc83f4708aaac35991306bca8f478351cfd2bda35750a62d7efcf05bb

LABEL maintainer="hal-9000"
LABEL description="HAL-9000 worker - Claude CLI with foundation MCP servers"
LABEL version="3.0.0"
LABEL architecture="dind-worker"
LABEL mcp_servers="chromadb, memory-bank, sequential-thinking"
LABEL build_date="2026-01-26"

# Install system dependencies
# - curl: Claude CLI installation and health checks
# - git: Development workflows
# - tmux: Session management
# - python3 + venv: Python MCP servers
# Note: Node.js 20 LTS is already included in node:20-bookworm-slim base image
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    git \
    tmux \
    python3 \
    python3-pip \
    python3-venv \
    locales \
    ncurses-term \
    gnupg \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /usr/share/doc/* /usr/share/man/* \
    && sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen \
    && locale-gen

# Set locale for proper UTF-8 support
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV TERM=xterm-256color

# ============================================================================
# Non-Root User (Security Hardening)
# ============================================================================

# Create non-root user for running Claude BEFORE installing user-specific tools
# UID/GID 1001 (avoiding conflict with node user UID 1000 in base image)
ARG CLAUDE_UID=1001
ARG CLAUDE_GID=1001

RUN groupadd -g ${CLAUDE_GID} claude && \
    useradd -u ${CLAUDE_UID} -g claude -m -d /home/claude -s /bin/bash claude && \
    # Create hal9000 group (GID 1002 for supplementary membership)
    # Workers need access to parent's hal9000-owned sockets/directories
    groupadd -g 1002 hal9000 && \
    usermod -aG hal9000 claude

# ============================================================================
# Directory Structure
# ============================================================================

# Create directories for:
# - /workspace: Project files (mounted per-session)
# - /home/claude/.claude: CLAUDE_HOME (shared volume for marketplace)
# - /data/memory-bank: Memory Bank data (shared volume)
# - /data/tmux-sockets: TMUX socket directory for inter-process communication
RUN mkdir -p /workspace /home/claude/.claude /data/memory-bank /data/tmux-sockets /scripts && \
    # SECURITY: Use 0770 instead of 0777 (restrict socket access to owner and group, not world)
    chmod 0770 /data/tmux-sockets && \
    chown -R claude:claude /workspace /home/claude /data/memory-bank /scripts

# ============================================================================
# Foundation MCP Servers (npm - installed globally as root)
# ============================================================================

# Memory Bank - persistent memory across sessions (npm)
# Data stored in shared volume: /data/memory-bank
RUN npm install -g @allpepper/memory-bank-mcp@0.2.2

# Sequential Thinking - step-by-step reasoning (npm)
RUN npm install -g @modelcontextprotocol/server-sequential-thinking@2025.12.18

# ============================================================================
# User-Specific Tools (installed as claude user)
# ============================================================================

# Switch to claude user for installing user-specific tools
# This ensures proper permissions without needing to copy binaries
USER claude
WORKDIR /home/claude

# Install uv (fast Python package installer) as claude user
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# Set PATH for uv before installing chroma-mcp
ENV PATH="/home/claude/.local/bin:${PATH}"

# ChromaDB MCP client - connects to parent's ChromaDB server (Python)
# Must be installed after uv and as claude user
RUN /home/claude/.local/bin/uv tool install chroma-mcp==0.2.6

# Install Claude CLI (native binary) as claude user
RUN curl -fsSL https://claude.ai/install.sh | bash

# Verify user-specific installations
RUN test -x /home/claude/.local/bin/claude && \
    test -x /home/claude/.local/bin/uv && \
    echo "✓ User tools installed and verified"

# Switch back to root for remaining setup
USER root

# Copy entrypoint and utility scripts
COPY docker/worker-entrypoint.sh /scripts/worker-entrypoint.sh
COPY scripts/tmux-send.sh /scripts/tmux-send.sh
COPY scripts/tmux-attach.sh /scripts/tmux-attach.sh
COPY scripts/tmux-list-sessions.sh /scripts/tmux-list-sessions.sh
RUN chmod +x /scripts/*.sh

# Environment variables
ENV CLAUDE_HOME=/home/claude/.claude
ENV WORKSPACE=/workspace
ENV MEMORY_BANK_ROOT=/data/memory-bank
ENV CHROMADB_HOST=localhost
ENV CHROMADB_PORT=8000
ENV HOME=/home/claude
ENV PATH="/home/claude/.local/bin:${PATH}"

# Switch to non-root user
USER claude

WORKDIR /workspace

# Verify installations - fail build if critical tools are missing
RUN echo "Verifying installations..." && \
    claude --version && \
    node --version && \
    npm --version && \
    uv --version && \
    echo "✓ Core tools verified" && \
    which mcp-server-memory-bank && echo "✓ memory-bank MCP server found" && \
    which mcp-server-sequential-thinking && echo "✓ sequential-thinking MCP server found" && \
    which chroma-mcp && echo "✓ chroma-mcp found" && \
    echo "Build verification complete - all tools functional"

# Health check
HEALTHCHECK --interval=60s --timeout=10s --start-period=5s --retries=3 \
    CMD claude --version >/dev/null 2>&1 || exit 1

ENTRYPOINT ["/scripts/worker-entrypoint.sh"]
CMD ["claude"]
