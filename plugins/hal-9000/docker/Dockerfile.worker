# HAL-9000 Worker Container
# Minimal Claude Code environment - marketplace-ready
#
# Philosophy:
# - Minimal base with Claude CLI + tooling for marketplace installs
# - CLAUDE_HOME mounted as persistent volume from parent
# - Users install MCP servers, agents, commands via marketplace
# - Everything persists in CLAUDE_HOME volume
#
# Build: docker build -f Dockerfile.worker -t ghcr.io/hellblazer/hal-9000:worker .

FROM debian:bookworm-slim

LABEL maintainer="hal-9000"
LABEL description="HAL-9000 worker - Minimal Claude CLI, marketplace-ready"
LABEL version="3.0.0"
LABEL architecture="dind-worker"
LABEL build_date="2026-01-26"

# Install system dependencies
# - curl: Claude CLI installation and marketplace operations
# - git: Development workflows
# - tmux: Session management
# - python3 + venv: Python MCP servers from marketplace
# - nodejs: npm MCP servers from marketplace
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    git \
    tmux \
    python3 \
    python3-pip \
    python3-venv \
    locales \
    ncurses-term \
    gnupg \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /usr/share/doc/* /usr/share/man/* \
    && sed -i '/en_US.UTF-8/s/^# //g' /etc/locale.gen \
    && locale-gen

# Set locale for proper UTF-8 support
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV TERM=xterm-256color

# Install Node.js 20 LTS (required for npm-based MCP servers)
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install Claude CLI (native binary)
RUN curl -fsSL https://claude.ai/install.sh | bash

# Add Claude CLI to PATH
ENV PATH="/root/.local/bin:${PATH}"

# Install uv (fast Python package installer for Python MCP servers)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# Create directory structure
# CLAUDE_HOME will be mounted as persistent volume from parent
RUN mkdir -p /workspace /root/.claude /scripts

# Copy entrypoint script
COPY docker/worker-entrypoint.sh /scripts/worker-entrypoint.sh
RUN chmod +x /scripts/worker-entrypoint.sh

# Environment variables
ENV CLAUDE_HOME=/root/.claude
ENV WORKSPACE=/workspace

WORKDIR /workspace

# Verify core installations
RUN echo "Verifying installations..." \
    && claude --version \
    && node --version \
    && npm --version \
    && uv --version \
    && echo "âœ“ Claude CLI and package managers ready"

# Health check - verify Claude CLI accessible
HEALTHCHECK --interval=60s --timeout=10s --start-period=5s --retries=3 \
    CMD claude --version >/dev/null 2>&1 || exit 1

ENTRYPOINT ["/scripts/worker-entrypoint.sh"]
CMD ["claude"]
