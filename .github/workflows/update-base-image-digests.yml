name: Update Base Image Digests

# Automated weekly check for base image updates
# Creates PR when new digests are available

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    name: Check for Base Image Updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check for digest updates
        id: check
        run: |
          chmod +x scripts/update-base-image-digests.sh

          # Check for updates
          if scripts/update-base-image-digests.sh --check; then
            echo "updates_available=false" >> $GITHUB_OUTPUT
            echo "No updates available"
          else
            echo "updates_available=true" >> $GITHUB_OUTPUT
            echo "Updates available!"
          fi

      - name: Apply updates
        if: steps.check.outputs.updates_available == 'true'
        run: |
          scripts/update-base-image-digests.sh --update

      - name: Validate updated digests
        if: steps.check.outputs.updates_available == 'true'
        run: |
          cd plugins/hal-9000/docker
          chmod +x validate-base-image-digests.sh
          ./validate-base-image-digests.sh

      - name: Create summary
        if: steps.check.outputs.updates_available == 'true'
        id: summary
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only | grep Dockerfile | xargs basename -a | paste -sd ", " -)

          # Create summary for PR body
          cat > /tmp/pr-body.md <<EOF
          ## Base Image Digest Updates

          This PR updates base image digests to the latest versions.

          ### Changed Files
          \`\`\`
          $CHANGED_FILES
          \`\`\`

          ### Validation
          - âœ… All new digests validated and accessible
          - âœ… Automated by \`update-base-image-digests.yml\`

          ### Review Checklist
          - [ ] Review digest changes in diff
          - [ ] Verify all affected Dockerfiles build successfully
          - [ ] Check for any breaking changes in base image release notes

          ### Base Images Updated
          $(git diff plugins/hal-9000/docker/Dockerfile* | grep "^+" | grep "FROM.*@sha256" | sed 's/^+/- /')

          ### Security
          Digest pinning ensures:
          - Immutable references to base images
          - Protection against upstream tag overwrites
          - Reproducible builds

          ---

          ðŸ¤– Automated by GitHub Actions
          Workflow: \`.github/workflows/update-base-image-digests.yml\`
          EOF

          echo "pr_body_file=/tmp/pr-body.md" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check.outputs.updates_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: Update base image digests to latest versions

            Automated update of pinned base image digests.

            Changes:
            - Updated base image digests to latest versions
            - Refreshed pin dates
            - Validated all new digests

            Generated by: .github/workflows/update-base-image-digests.yml
          branch: automated/update-base-image-digests
          delete-branch: true
          title: 'chore: Update base image digests'
          body-path: ${{ steps.summary.outputs.pr_body_file }}
          labels: |
            dependencies
            security
            automated

      - name: No updates available
        if: steps.check.outputs.updates_available == 'false'
        run: |
          echo "âœ… All base image digests are up to date"
          echo "No PR needed"
