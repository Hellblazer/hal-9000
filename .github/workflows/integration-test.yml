name: Integration Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'plugins/hal-9000/**'
      - 'templates/**'
      - '.github/workflows/integration-test.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'plugins/hal-9000/**'
      - 'templates/**'
  workflow_dispatch:

jobs:
  quick-smoke-test:
    name: Quick Smoke Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate shell scripts
        run: |
          echo "Validating shell scripts..."
          find plugins/hal-9000 -name "*.sh" -type f -exec bash -n {} \;
          echo "All scripts valid"

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          for f in $(find . -name "*.json" -not -path "./.git/*"); do
            echo "Checking $f"
            jq empty "$f" || exit 1
          done
          echo "All JSON valid"

      - name: Check version consistency
        run: |
          echo "Checking version consistency..."

          PLUGIN_VERSION=$(jq -r '.version' plugins/hal-9000/.claude-plugin/plugin.json)
          MARKETPLACE_VERSION=$(jq -r '.plugins[0].version' .claude-plugin/marketplace.json)
          BUILD_VERSION=$(grep 'readonly VERSION=' plugins/hal-9000/docker/build-profiles.sh | cut -d'"' -f2)

          echo "plugin.json: $PLUGIN_VERSION"
          echo "marketplace.json: $MARKETPLACE_VERSION"
          echo "build-profiles.sh: $BUILD_VERSION"

          if [ "$PLUGIN_VERSION" != "$MARKETPLACE_VERSION" ]; then
            echo "ERROR: Version mismatch between plugin.json and marketplace.json"
            exit 1
          fi

          if [ "$PLUGIN_VERSION" != "$BUILD_VERSION" ]; then
            echo "ERROR: Version mismatch between plugin.json and build-profiles.sh"
            exit 1
          fi

          echo "All versions consistent: $PLUGIN_VERSION"

      - name: Check hooks bundled
        run: |
          echo "Verifying safety hooks are bundled..."
          HOOKS_DIR="plugins/hal-9000/hooks"

          required_hooks=(
            "bash_hook.py"
            "env_file_protection_hook.py"
            "file_length_limit_hook.py"
            "git_add_block_hook.py"
            "git_checkout_safety_hook.py"
            "git_commit_block_hook.py"
            "rm_block_hook.py"
            "hooks.json"
          )

          for hook in "${required_hooks[@]}"; do
            if [ -f "$HOOKS_DIR/$hook" ]; then
              echo "✓ $hook"
            else
              echo "✗ Missing: $hook"
              exit 1
            fi
          done

          echo "All hooks bundled"

      - name: Check agents bundled
        run: |
          echo "Verifying custom agents are bundled..."
          AGENTS_DIR="plugins/hal-9000/agents"

          agent_count=$(ls -1 "$AGENTS_DIR"/*.md 2>/dev/null | wc -l)
          if [ "$agent_count" -ge 10 ]; then
            echo "✓ $agent_count agents bundled"
          else
            echo "✗ Expected 10+ agents, found $agent_count"
            exit 1
          fi

  full-integration-test:
    name: Full Integration Test (Ubuntu)
    runs-on: ubuntu-latest
    needs: quick-smoke-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build full test image
        uses: docker/build-push-action@v5
        with:
          context: ./plugins/hal-9000
          file: ./plugins/hal-9000/docker/Dockerfile.test-full
          build-contexts: |
            templates=./templates
          push: false
          load: true
          tags: hal9000-test-full:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run full integration tests
        run: |
          docker run --rm \
            --name hal9000-full-test \
            hal9000-test-full:latest \
            /hal-9000/test/run-full-tests.sh

      - name: Collect logs on failure
        if: failure()
        run: |
          # Container already removed with --rm, but capture any remaining info
          echo "Test failed - check output above for details"

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [quick-smoke-test, full-integration-test]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "=== Test Results ==="
          echo ""

          if [ "${{ needs.quick-smoke-test.result }}" = "success" ]; then
            echo "✓ Quick Smoke Test: PASSED"
          else
            echo "✗ Quick Smoke Test: FAILED"
          fi

          if [ "${{ needs.full-integration-test.result }}" = "success" ]; then
            echo "✓ Full Integration Test: PASSED"
          else
            echo "✗ Full Integration Test: FAILED"
          fi

          echo ""

          if [ "${{ needs.quick-smoke-test.result }}" != "success" ] || \
             [ "${{ needs.full-integration-test.result }}" != "success" ]; then
            echo "Some tests failed!"
            exit 1
          fi

          echo "All tests passed!"
