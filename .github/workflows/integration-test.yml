name: Integration Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'plugins/hal-9000/**'
      - 'scripts/build/test-*.sh'
      - 'scripts/tests/run-*.sh'
      - 'templates/**'
      - 'Makefile'
      - '.github/workflows/integration-test.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'plugins/hal-9000/**'
      - 'scripts/build/test-*.sh'
      - 'scripts/tests/run-*.sh'
      - 'templates/**'
      - 'Makefile'
  workflow_dispatch:

jobs:
  quick-smoke-test:
    name: Quick Smoke Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate shell scripts
        run: |
          echo "Validating shell scripts..."
          find plugins/hal-9000 -name "*.sh" -type f -exec bash -n {} \;
          echo "All scripts valid"

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          for f in $(find . -name "*.json" -not -path "./.git/*"); do
            echo "Checking $f"
            jq empty "$f" || exit 1
          done
          echo "All JSON valid"

      - name: Check version consistency
        run: |
          echo "Checking version consistency..."

          PLUGIN_VERSION=$(jq -r '.version' plugins/hal-9000/.claude-plugin/plugin.json)
          MARKETPLACE_VERSION=$(jq -r '.plugins[0].version' .claude-plugin/marketplace.json)
          BUILD_VERSION=$(grep 'readonly VERSION=' plugins/hal-9000/docker/build-profiles.sh | cut -d'"' -f2)

          echo "plugin.json: $PLUGIN_VERSION"
          echo "marketplace.json: $MARKETPLACE_VERSION"
          echo "build-profiles.sh: $BUILD_VERSION"

          if [ "$PLUGIN_VERSION" != "$MARKETPLACE_VERSION" ]; then
            echo "ERROR: Version mismatch between plugin.json and marketplace.json"
            exit 1
          fi

          if [ "$PLUGIN_VERSION" != "$BUILD_VERSION" ]; then
            echo "ERROR: Version mismatch between plugin.json and build-profiles.sh"
            exit 1
          fi

          echo "All versions consistent: $PLUGIN_VERSION"

      - name: Check hooks bundled
        run: |
          echo "Verifying safety hooks are bundled..."
          HOOKS_DIR="plugins/hal-9000/hooks"

          required_hooks=(
            "bash_hook.py"
            "env_file_protection_hook.py"
            "file_length_limit_hook.py"
            "git_add_block_hook.py"
            "git_checkout_safety_hook.py"
            "git_commit_block_hook.py"
            "rm_block_hook.py"
            "hooks.json"
          )

          for hook in "${required_hooks[@]}"; do
            if [ -f "$HOOKS_DIR/$hook" ]; then
              echo "✓ $hook"
            else
              echo "✗ Missing: $hook"
              exit 1
            fi
          done

          echo "All hooks bundled"

      - name: Check Docker files
        run: |
          echo "Verifying Docker infrastructure..."
          DOCKER_DIR="plugins/hal-9000/docker"

          required_files=(
            "Dockerfile.parent"
            "Dockerfile.worker"
            "Dockerfile.hal9000"
            "build-profiles.sh"
            "spawn-worker.sh"
          )

          for file in "${required_files[@]}"; do
            if [ -f "$DOCKER_DIR/$file" ]; then
              echo "✓ $file"
            else
              echo "✗ Missing: $file"
              exit 1
            fi
          done

          echo "All Docker files present"

      - name: Check security documentation
        run: |
          echo "Verifying security documentation..."
          if [ -f "plugins/hal-9000/SECURITY.md" ]; then
            echo "✓ SECURITY.md present"
          else
            echo "✗ SECURITY.md missing"
            exit 1
          fi

  comprehensive-tests:
    name: Comprehensive Test Suite
    runs-on: ubuntu-latest
    needs: quick-smoke-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Phase 1 - Foundation Tests
        run: |
          echo "Running Phase 1: Foundation Tests (30 tests)..."
          bash scripts/build/test-hal9000-unit-extended.sh help
          bash scripts/build/test-hal9000-unit-extended.sh profile
          bash scripts/build/test-hal9000-unit-extended.sh session
          echo "✓ Phase 1 passed"

      - name: Phase 2 - Docker Integration Tests
        run: |
          echo "Running Phase 2: Docker Integration Tests (32 tests)..."
          bash plugins/hal-9000/docker/test-phase2-session-lifecycle.sh
          echo "✓ Phase 2 passed"

      - name: Phase 3 - Daemon & Performance Tests
        run: |
          echo "Running Phase 3: Daemon & Performance Tests (44 tests)..."
          bash plugins/hal-9000/docker/test-phase3-performance.sh
          echo "✓ Phase 3 passed"

      - name: Phase 4 - Integration Scenarios
        run: |
          echo "Running Phase 4: Integration Scenarios (28 tests)..."
          bash scripts/tests/run-integration-scenarios.sh
          echo "✓ Phase 4 passed"

  docker-build-test:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [quick-smoke-test, comprehensive-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build worker image
        uses: docker/build-push-action@v5
        with:
          context: ./plugins/hal-9000
          file: ./plugins/hal-9000/docker/Dockerfile.worker
          push: false
          load: true
          tags: hal9000-worker-test:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify worker image
        run: |
          echo "Testing worker image..."

          # Override entrypoint for test commands
          # Check non-root user is configured
          docker run --rm --entrypoint id hal9000-worker-test:latest | grep -q "claude" || {
            echo "✗ Container not running as claude user"
            exit 1
          }
          echo "✓ Container runs as non-root user (claude)"

          # Actually execute Claude CLI (not just which)
          docker run --rm --entrypoint claude hal9000-worker-test:latest --version || {
            echo "✗ Claude CLI not functional"
            exit 1
          }
          echo "✓ Claude CLI functional"

          # Execute uv to verify it works
          docker run --rm --entrypoint uv hal9000-worker-test:latest --version || {
            echo "✗ uv not functional"
            exit 1
          }
          echo "✓ uv functional"

          # Execute MCP servers with --help to verify they work
          docker run --rm --entrypoint mcp-server-memory-bank hal9000-worker-test:latest --help > /dev/null 2>&1 || {
            echo "✗ memory-bank MCP server not functional"
            exit 1
          }
          echo "✓ memory-bank MCP server functional"

          docker run --rm --entrypoint mcp-server-sequential-thinking hal9000-worker-test:latest --help > /dev/null 2>&1 || {
            echo "✗ sequential-thinking MCP server not functional"
            exit 1
          }
          echo "✓ sequential-thinking MCP server functional"

          # Verify chroma-mcp works
          docker run --rm --entrypoint chroma-mcp hal9000-worker-test:latest --help > /dev/null 2>&1 || {
            echo "✗ chroma-mcp not functional"
            exit 1
          }
          echo "✓ chroma-mcp functional"

          # Show binary permissions for debugging
          echo "Binary permissions:"
          docker run --rm --entrypoint ls hal9000-worker-test:latest -la /home/claude/.local/bin/

          echo "✓ All worker image verifications passed"

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [quick-smoke-test, comprehensive-tests, docker-build-test]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "=== Test Results ==="
          echo ""

          if [ "${{ needs.quick-smoke-test.result }}" = "success" ]; then
            echo "✓ Quick Smoke Test: PASSED"
          else
            echo "✗ Quick Smoke Test: FAILED"
          fi

          if [ "${{ needs.comprehensive-tests.result }}" = "success" ]; then
            echo "✓ Comprehensive Tests (134 tests): PASSED"
          else
            echo "✗ Comprehensive Tests: FAILED"
          fi

          if [ "${{ needs.docker-build-test.result }}" = "success" ]; then
            echo "✓ Docker Build Test: PASSED"
          else
            echo "✗ Docker Build Test: FAILED"
          fi

          echo ""

          if [ "${{ needs.quick-smoke-test.result }}" != "success" ] || \
             [ "${{ needs.comprehensive-tests.result }}" != "success" ] || \
             [ "${{ needs.docker-build-test.result }}" != "success" ]; then
            echo "Some tests failed!"
            exit 1
          fi

          echo "All tests passed (quick-smoke + comprehensive + docker-build)!"
